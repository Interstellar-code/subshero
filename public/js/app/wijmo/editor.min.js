import*as wjcCore from"@grapecity/wijmo";import*as wjcGrid from"@grapecity/wijmo.grid";import*as wjcInput from"@grapecity/wijmo.input";class CustomGridEditor{constructor(grid,binding,edtClass,options){this._grid=grid,this._col=grid.columns.getColumn(binding),this._errorTip=new wjcCore.Tooltip({isContentHtml:!1,showDelay:0,cssClass:"wj-error-tip"}),this._ctl=new edtClass(document.createElement("div"),options),wjcCore.addClass(this._ctl.hostElement,"custom-editor"),wjcCore.setCss(this._ctl.hostElement,{position:"relative",height:"100%",borderRadius:"0px",border:"none"}),this._host=document.createElement("div"),this._host.appendChild(this._ctl.hostElement),grid.beginningEdit.addHandler(this._beginningEdit,this),grid.sortingColumn.addHandler(()=>{this._commitRowEdits()}),grid.scrollPositionChanged.addHandler(()=>{this._ctl.containsFocus()&&grid.focus()}),grid.selectionChanging.addHandler((s,e)=>{e.row!=s.selection.row&&this._commitRowEdits()}),this._ctl.addEventListener(this._ctl.hostElement,"keydown",e=>{switch(e.keyCode){case wjcCore.Key.Tab:case wjcCore.Key.Enter:e.preventDefault(),this._closeEditor(!0),this._grid.focus();var evt=document.createEvent("HTMLEvents");evt.initEvent("keydown",!0,!0),"altKey,metaKey,ctrlKey,shiftKey,keyCode".split(",").forEach(prop=>{evt[prop]=e[prop]}),this._grid.hostElement.dispatchEvent(evt);break;case wjcCore.Key.Escape:this._closeEditor(!1),this._grid.focus()}}),this._ctl.lostFocus.addHandler(()=>{setTimeout(()=>{this._ctl.containsFocus()||(this._closeEditor(!0),this._grid.onLostFocus())})}),this._grid.lostFocus.addHandler(()=>{setTimeout(()=>{this._grid.containsFocus()||CustomGridEditor._isEditing||this._commitRowEdits()})}),this._grid.addEventListener(this._grid.hostElement,"keydown",e=>{var colIndex;this._openDropDown=!1,(e.keyCode==wjcCore.Key.F4||e.altKey&&(e.keyCode==wjcCore.Key.Down||e.keyCode==wjcCore.Key.Up))&&-1<(colIndex=this._grid.selection.col)&&this._grid.columns[colIndex]==this._col&&(this._openDropDown=!0,this._grid.startEditing(!0),e.preventDefault()),e.keyCode==wjcCore.Key.Enter&&this._commitRowEdits()},!0),window.addEventListener("resize",()=>{this._ctl.containsFocus()&&(this._closeEditor(!0),this._grid.focus())})}get control(){return this._ctl}_beginningEdit(grid,args){var evt,error,rcBody,zIndex,ecv,item;grid.columns[args.col]!=this._col||(evt=args.data)&&evt.keyCode==wjcCore.Key.Delete||(args.cancel=!0,this._rng=args.range,CustomGridEditor._isEditing=!0,grid.refreshRange(this._rng),grid._getShowErrors()?(error=grid._getError(args.panel,args.row,args.col),this._showError(error)):this._clearError(),error=grid.getCellBoundingRect(args.row,args.col),rcBody=document.body.getBoundingClientRect(),rcBody=new wjcCore.Point(-rcBody.left,-rcBody.top),zIndex=args.row<grid.frozenRows||args.col<grid.frozenColumns?"3":"",wjcCore.setCss(this._host,{position:"absolute",overflow:"hidden",left:error.left+rcBody.x-1,top:error.top+rcBody.y-1,width:error.width+2,height:grid.rows[args.row].renderHeight+2,backgroundColor:"transparent",padding:"2px",zIndex:zIndex}),this._ctl.value=grid.getCellData(this._rng.row,this._rng.col,!1),ecv=grid.editableCollectionView,item=grid.rows[args.row].dataItem,ecv&&item&&item!=ecv.currentEditItem&&setTimeout(function(){grid.onRowEditStarting(args),ecv.editItem(item),grid.onRowEditStarted(args)},50),document.body.appendChild(this._host),this._ctl.focus(),setTimeout(()=>{var key=evt&&32<evt.charCode?String.fromCharCode(evt.charCode):null,input=this._ctl.hostElement.querySelector("input");input&&(key?(input.value=key,wjcCore.setSelectionRange(input,key.length,key.length),(key=document.createEvent("HTMLEvents")).initEvent("input",!0,!1),input.dispatchEvent(key)):input.select()),input||this._openDropDown||this._ctl.focus(),this._openDropDown&&this._ctl instanceof wjcInput.DropDown&&(this._ctl.isDroppedDown=!0,this._ctl.dropDown.focus())},50))}_closeEditor(saveEdits){if(this._rng){var flexGrid=this._grid,ctl=this._ctl,e=new wjcGrid.CellEditEndingEventArgs(flexGrid.cells,this._rng);if(flexGrid.onCellEditEnding(e),saveEdits){if(wjcCore.isUndefined(ctl.value)){if(wjcCore.isUndefined(ctl.text))throw"Can't get editor value/text...";this._grid.setCellData(this._rng.row,this._rng.col,ctl.text)}else this._grid.setCellData(this._rng.row,this._rng.col,ctl.value);this._grid.invalidate()}ctl instanceof wjcInput.DropDown&&(ctl.isDroppedDown=!1),this._host.parentElement.removeChild(this._host),this._rng=null,CustomGridEditor._isEditing=!1,flexGrid.onCellEditEnded(e)}}_commitRowEdits(){var e,flexGrid=this._grid,ecv=flexGrid.editableCollectionView;this._closeEditor(!0),ecv&&ecv.currentEditItem&&(e=new wjcGrid.CellEditEndingEventArgs(flexGrid.cells,flexGrid.selection),ecv.commitEdit(),setTimeout(()=>{flexGrid.onRowEditEnding(e),flexGrid.onRowEditEnded(e),flexGrid.invalidate()}))}_clearError(){this._showError(null)}_showError(error){wjcCore.toggleClass(this._ctl.hostElement,"custom-editor-invalid",!!error),this._errorTip.setTooltip(this._ctl.hostElement,null),setTimeout(()=>{this._errorTip.setTooltip(this._ctl.hostElement,error)})}}export{CustomGridEditor};