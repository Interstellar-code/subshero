import*as wjcCore from"@grapecity/wijmo";import*as wjcGrid from"@grapecity/wijmo.grid";import*as wjcGridPdf from"@grapecity/wijmo.grid.pdf";import*as wjcGridXlsx from"@grapecity/wijmo.grid.xlsx";import*as wjcPdf from"@grapecity/wijmo.pdf";import*as wjcXlsx from"@grapecity/wijmo.xlsx";import{KeyValue,Country}from"./data.min.js";const ExcelExportDocName="FlexGrid.xlsx",PdfExportDocName="FlexGrid.pdf",FakeColumn=new wjcGrid.Column,FakeRow=new wjcGrid.Row;class Fonts{}Fonts.ZapfDingbatsSm=new wjcPdf.PdfFont("zapfdingbats",8,"normal","normal"),Fonts.ZapfDingbatsLg=new wjcPdf.PdfFont("zapfdingbats",16,"normal","normal");class IExcelExportContext{}class ExportService{startExcelExport(flex,ctx){ctx.preparing||ctx.exporting||(ctx.exporting=!1,ctx.progress=0,ctx.preparing=!0,wjcGridXlsx.FlexGridXlsxConverter.saveAsync(flex,{includeColumnHeaders:!0,includeStyles:!1,formatItem:this._formatExcelItem.bind(this)},ExcelExportDocName,()=>{console.log("Export to Excel completed"),this._resetExcelContext(ctx)},err=>{console.error("Export to Excel failed: "+err),this._resetExcelContext(ctx)},prg=>{ctx.preparing&&(ctx.exporting=!0,ctx.preparing=!1),ctx.progress=prg/100},!0),console.log("Export to Excel started"))}cancelExcelExport(ctx){wjcGridXlsx.FlexGridXlsxConverter.cancelAsync(()=>{console.log("Export to Excel canceled"),this._resetExcelContext(ctx)})}exportToPdf(flex,options){wjcGridPdf.FlexGridPdfConverter.export(flex,PdfExportDocName,{maxPages:100,exportMode:wjcGridPdf.ExportMode.All,scaleMode:wjcGridPdf.ScaleMode.ActualSize,documentOptions:{pageSettings:{layout:wjcPdf.PdfPageOrientation.Landscape},header:{declarative:{text:"\t&[Page]\\&[Pages]"}},footer:{declarative:{text:"\t&[Page]\\&[Pages]"}}},styles:{cellStyle:{backgroundColor:"#ffffff",borderColor:"#c6c6c6"},altCellStyle:{backgroundColor:"#f9f9f9"},groupCellStyle:{backgroundColor:"#dddddd"},headerCellStyle:{backgroundColor:"#eaeaea"},errorCellStyle:{backgroundColor:"rgba(255, 0, 0, 0.3)"}},customCellContent:!1,formatItem:e=>this._formatPdfItem(e,options)})}_formatExcelItem(e){var panel=e.panel;panel.cellType===wjcGrid.CellType.Cell&&panel.grid._getError(panel,e.row,e.col)&&((panel=new wjcXlsx.WorkbookFill).color="#ff0000",e.xlsxCell.style.fill=panel)}_resetExcelContext(ctx){ctx.exporting=!1,ctx.progress=0,ctx.preparing=!1}_formatPdfItem(e,options){var panel=e.panel;if(panel.cellType===wjcGrid.CellType.Cell)switch(panel.columns[e.col].binding){case"countryId":this._formatPdfCountryCell(e,options.countryMap);break;case"colorId":this._formatPdfColorCell(e,options.colorMap);break;case"change":this._formatPdfChangeCell(e);break;case"history":var history=e.panel.getCellData(e.row,e.col,!1),history=this._createCellFromCellTemplate(options.historyCellTemplate,history);this._formatPdfHistoryCell(e,history);break;case"rating":this._formatPdfRatingCell(e)}}_formatPdfCountryCell(e,countryMap){e.drawBackground(e.style.backgroundColor);var image,imageTop,countryName=e.data;this._isCountryExist(countryName,countryMap)&&(countryMap=e.contentRect,image=e.canvas.openImage(`resources/${countryName}.png`),imageTop=countryMap.top+(countryMap.height-image.height)/2,e.canvas.drawImage(image,countryMap.left,imageTop),e.canvas.drawText(countryName,countryMap.left+image.width+3,e.textTop)),e.cancel=!0}_formatPdfColorCell(e,colorMap){e.drawBackground(e.style.backgroundColor);var imageHeight,imageTop,colorName=e.data;this._isColorExist(colorName,colorMap)&&(colorMap=e.contentRect,imageHeight=Math.min(10,colorMap.height),imageTop=colorMap.top+(colorMap.height-imageHeight)/2,e.canvas.paths.rect(colorMap.left,imageTop,imageTop=1.33*imageHeight,imageHeight).fillAndStroke(wjcCore.Color.fromString(colorName),wjcCore.Color.fromString("gray")),e.canvas.drawText(colorName,colorMap.left+imageTop+3,e.textTop)),e.cancel=!0}_formatPdfChangeCell(e){e.drawBackground(e.style.backgroundColor);var cellData=e.panel.getCellData(e.row,e.col,!1);let change=0,changeText="",changeIndicator=(wjcCore.isNumber(cellData)?(change=cellData,changeText=wjcCore.Globalize.formatNumber(change,"c")):wjcCore.isUndefined(cellData)||null===cellData||(changeText=wjcCore.changeType(cellData,wjcCore.DataType.String)),""),changeColor=e.style.color;0<change?(changeIndicator="s",changeColor="darkgreen"):change<0&&(changeIndicator="t",changeColor="darkred");e.canvas.drawText(changeIndicator,e.contentRect.right-10,e.contentRect.top+10,{brush:changeColor,font:Fonts.ZapfDingbatsSm}),e.canvas.drawText(changeText,e.contentRect.left,e.textTop,{brush:changeColor,align:wjcPdf.PdfTextHorizontalAlign.Right,width:e.contentRect.width-13}),e.cancel=!0}_formatPdfHistoryCell(e,cell){e.drawBackground(e.style.backgroundColor);var cr,cell=this._getHistorySvgDataUrlFromCell(cell,e.clientRect.width,e.clientRect.height);cell&&(cr=e.contentRect,e.canvas.drawSvg(cell,cr.left+2,cr.top+2,{width:cr.width-4,height:cr.height-4})),e.cancel=!0}_getHistorySvgDataUrlFromCell(cell,width,height){let dataUrl=null;var defs,s,cell=cell.getElementsByTagName("svg")[0];return cell&&((cell=cell.cloneNode(!0)).setAttribute("version","1.1"),cell.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns","http://www.w3.org/2000/svg"),cell.style.overflow="visible",cell.style.stroke="#376092",cell.style.fill="#376092",(s=document.createElement("style")).setAttribute("type","text/css"),s.innerHTML=`<![CDATA[
          line { 
              stroke-width: 2;
          }
          circle { 
              stroke-width: 0;
              stroke-opacity: 0; 
          }
          .wj-marker { 
              fill: #d00000; 
              opacity: 1; 
          }
      ]]>`,(defs=document.createElement("defs")).appendChild(s),cell.insertBefore(defs,cell.firstChild),(s=document.createElement("div")).appendChild(cell),dataUrl="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(s.innerHTML)))),dataUrl}_formatPdfRatingCell(e){e.drawBackground(e.style.backgroundColor);var rating=wjcCore.changeType(e.data,wjcCore.DataType.Number);if(wjcCore.isInt(rating)){var ratingNormalColor=wjcCore.Color.fromRgba(255,165,0,1),ratingLightColor=wjcCore.Color.fromRgba(255,165,0,.2),y=e.clientRect.top+16;let x=e.contentRect.left+(e.contentRect.width-80)/2;rating=wjcCore.clamp(rating,1,5);for(let i=0;i<5;i++)e.canvas.drawText("H",x,y,{brush:i<rating?ratingNormalColor:ratingLightColor,font:Fonts.ZapfDingbatsLg,height:e.clientRect.height}),x+=16}e.cancel=!0}_isCountryExist(countryName,countryMap){countryMap=countryMap.getKeyValue(countryName);return!wjcCore.isUndefined(countryMap)&&null!==countryMap&&countryMap!==Country.NotFound.id}_isColorExist(colorName,colorMap){colorMap=colorMap.getKeyValue(colorName);return!wjcCore.isUndefined(colorMap)&&null!==colorMap&&colorMap!==KeyValue.NotFound.key}_createCellFromCellTemplate(cellTemplate,data){var cell=document.createElement("div");return cellTemplate({col:FakeColumn,row:FakeRow,value:data,item:null,text:null},cell),cell}}export{IExcelExportContext,ExportService};